# گزارش تحلیل سیستم هوش مصنوعی و چت‌بات (AI System Analysis Report)

این گزارش شامل تحلیل دقیق وضعیت فعلی هوش مصنوعی در سیستم، نحوه تعامل آن با داده‌ها و نیازمندی‌های اتصال کامل به بخش مدیریت انبار (Warehouse) است.

---

## ۱. ساختار فایل‌ها و کامپوننت‌ها (System Architecture)

| فایل | نقش در سیستم | تکنولوژی/API |
| :--- | :--- | :--- |
| `services/chat_service.py` | مغز متفکر چت‌بات؛ مسئول ساخت Context و مدیریت تاریخچه پیام‌ها. | GROQ (Llama 3.3 70B) |
| `services/llama_analyzer.py` | تحلیل‌گر تخصصی برای گزارش‌های پارتو، ضایعات و پیشنهاد خرید (Reorder). | GROQ (Llama 3.3 70B) |
| `routes/chat.py` | مدیریت روت‌های مربوط به رابط کاربری چت و APIهای آن. | - |
| `routes/ai_analysis.py` | روت‌های مربوط به صفحات تحلیل هوشمند (Insights). | - |
| `models/chat_history.py` | ذخیره‌سازی تاریخچه مکالمات برای هر کاربر جهت حفظ حافظه (Memory). | SQLite/PostgreSQL |
| `templates/chat/index.html` | رابط کاربری چت (Frontend). | Tailwind/JS |

---

## ۲. نحوه ساخت محتوا برای هوش مصنوعی (Context Building)

هوش مصنوعی مستقیماً به دیتابیس وصل نیست؛ بلکه در هر پیام، خلاصه‌ای از وضعیت سیستم توسط متد `_get_full_database_context` ساخته شده و برای مدل ارسال می‌شود.

### داده‌های فعلی در Context:
- **آمار کلی اقلام:** تعداد کل کالاها، تفکیک غذایی/غیرغذایی.
- **توزیع هتل‌ها:** لیست هتل‌هایی که کاربر به آن‌ها دسترسی دارد و تعداد کالای هر کدام.
- **تراکنش‌های ۳۰ روز اخیر:** مجموع ریالی خرید، مصرف و ضایعات.
- **شاخص ضایعات:** نسبت درصد ضایعات به خرید.
- **تحلیل پارتو (ABC):** لیست ۵ کالای برتر در هر کلاس (A, B, C) برای بخش غذایی و غیرغذایی.
- **تراکنش‌های امروز:** تعداد فعالیت‌های ثبت شده در تاریخ جاری.

---

## ۳. امنیت و دسترسی (Hotel Scoping)

سیستم به طور کامل از قوانین **Hotel Scoping** پیروی می‌کند:
- **فیلترینگ:** تمام کوئری‌ها در `ChatService` بر اساس `get_allowed_hotel_ids` محدود شده‌اند.
- **عدم نشت داده:** یک کاربر معمولی (غیر ادمین) به هیچ عنوان نمی‌تواند آمار یا اطلاعات هتل‌هایی که در پروفایلش تعریف نشده را از طریق چت‌بات دریافت کند.
- **ادمین‌ها:** کاربران ادمین به داده‌های تمام هتل‌ها دسترسی دارند.

---

## ۴. کمبودها در بخش انبار (Missing Warehouse Integration)

با توجه به پیاده‌سازی اخیر سیستم مدیریت انبار (WMS)، موارد زیر هنوز به هوش مصنوعی منتقل نمی‌شوند:

| مورد | اهمیت | توضیح |
| :--- | :--- | :--- |
| **موجودی لحظه‌ای (Stock)** | حیاتی (P0) | AI نمی‌داند دقیقاً چند عدد از یک کالا در انبار موجود است. |
| **هشدارهای انبار (Alerts)** | حیاتی (P0) | هشدارهای اتمام موجودی یا موجودی بیش از حد در Context نیستند. |
| **تأییدیه‌های معلق (Approvals)** | بالا (P1) | تعداد تراکنش‌هایی که منتظر تأیید مدیر هستند. |
| **دلایل ضایعات (Waste Reasons)** | متوسط (P1) | تحلیل این‌که "چرا" ضایعات رخ داده (خرابی، انقضا و ...). |
| **مغایرت‌های انبارگردانی** | متوسط (P2) | آمار مربوط به انبارگردانی‌های اخیر و درصدهای خطا. |

---

## ۵. نقشه راه اتصال کامل (Integration Roadmap)

برای این‌که سیستم کاملاً هوشمند شود، مراحل زیر در حال اجرا یا برنامه‌ریزی است:

1.  **بروزرسانی Context:** اضافه کردن خروجی‌های `WarehouseService` به متد ساخت Context در چت‌بات.
2.  **تحلیل ضایعات هوشمند:** اتصال `WasteAnalysisService` به چت‌بات برای پاسخ به سوالاتی مثل "چرا ضایعات این ماه بالا بود؟".
3.  **پیشنهاد خرید هوشمند:** استفاده از موجودی لحظه‌ای برای پیشنهاد خودکار لیست خرید در محیط چت.
4.  **دستیار انبارگردانی:** هدایت کاربر برای انجام انبارگردانی اقلامی که مدت زیادی است شمارش نشده‌اند.

---

## ۶. جزئیات فنی API

- **مدل مورد استفاده:** `llama-3.3-70b-versatile` (سریع‌ترین و قوی‌ترین مدل فعلی در پلتفرم GROQ).
- **دمای پاسخگویی (Temperature):** 0.7 (ایجاد تعادل بین دقت داده‌ها و لحن صمیمی).
- **محدودیت حافظه:** ۱۰ پیام آخر هر کاربر برای حفظ تمرکز مدل در گفتگو.

---
*تنظیم شده توسط: دستیار توسعه پارتو*
