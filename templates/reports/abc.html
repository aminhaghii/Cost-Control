{% extends 'base.html' %}

{% block title %}طبقه‌بندی ABC{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h2><i class="fas fa-layer-group me-2"></i> طبقه‌بندی ABC</h2>
    <a href="{{ url_for('export.download_abc_excel', mode=mode, category=category, days=days) }}" 
       class="btn btn-success">
        <i class="fas fa-file-excel me-2"></i> دانلود Excel
    </a>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">نوع تراکنش</label>
                <select name="mode" class="form-select">
                    <option value="خرید" {% if mode == 'خرید' %}selected{% endif %}>خرید</option>
                    <option value="ضایعات" {% if mode == 'ضایعات' %}selected{% endif %}>ضایعات</option>
                    <option value="مصرف" {% if mode == 'مصرف' %}selected{% endif %}>مصرف</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">گروه</label>
                <select name="category" class="form-select">
                    <option value="Food" {% if category == 'Food' %}selected{% endif %}>مواد غذایی</option>
                    <option value="NonFood" {% if category == 'NonFood' %}selected{% endif %}>مواد غیرغذایی</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">دوره زمانی</label>
                <select name="days" class="form-select">
                    <option value="7" {% if days == 7 %}selected{% endif %}>7 روز اخیر</option>
                    <option value="30" {% if days == 30 %}selected{% endif %}>30 روز اخیر</option>
                    <option value="90" {% if days == 90 %}selected{% endif %}>90 روز اخیر</option>
                    <option value="365" {% if days == 365 %}selected{% endif %}>یک سال اخیر</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-1"></i> اعمال فیلتر
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ABC Summary -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card border-success h-100">
            <div class="card-header bg-success text-white">
                <i class="fas fa-star me-2"></i>
                {{ recommendations.A.icon }} {{ recommendations.A.title }}
            </div>
            <div class="card-body">
                <h3 class="text-success mb-3">{{ classified.A | length }} کالا</h3>
                <p class="text-muted">{{ recommendations.A.subtitle }}</p>
                <hr>
                <h6 class="fw-bold">توصیه‌های مدیریتی:</h6>
                <ul class="small">
                    {% for action in recommendations.A.actions %}
                    <li>{{ action }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card border-warning h-100">
            <div class="card-header bg-warning text-dark">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {{ recommendations.B.icon }} {{ recommendations.B.title }}
            </div>
            <div class="card-body">
                <h3 class="text-warning mb-3">{{ classified.B | length }} کالا</h3>
                <p class="text-muted">{{ recommendations.B.subtitle }}</p>
                <hr>
                <h6 class="fw-bold">توصیه‌های مدیریتی:</h6>
                <ul class="small">
                    {% for action in recommendations.B.actions %}
                    <li>{{ action }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card border-secondary h-100">
            <div class="card-header bg-secondary text-white">
                <i class="fas fa-circle me-2"></i>
                {{ recommendations.C.icon }} {{ recommendations.C.title }}
            </div>
            <div class="card-body">
                <h3 class="text-secondary mb-3">{{ classified.C | length }} کالا</h3>
                <p class="text-muted">{{ recommendations.C.subtitle }}</p>
                <hr>
                <h6 class="fw-bold">توصیه‌های مدیریتی:</h6>
                <ul class="small">
                    {% for action in recommendations.C.actions %}
                    <li>{{ action }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Class A Items -->
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <i class="fas fa-check-circle me-2"></i>
        کلاس A: اقلام حیاتی ({{ classified.A | length }} کالا)
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-success">
                    <tr>
                        <th>کد کالا</th>
                        <th>نام کالا</th>
                        <th>واحد</th>
                        <th>مقدار کل</th>
                        <th>مبلغ کل</th>
                        <th>درصد سهم</th>
                        <th>درصد تجمعی</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in classified.A %}
                    <tr>
                        <td><code>{{ item.item_code }}</code></td>
                        <td>{{ item.item_name }}</td>
                        <td>{{ item.unit }}</td>
                        <td class="number-fa">{{ "{:,.2f}".format(item.total_quantity) }}</td>
                        <td class="number-fa fw-bold">{{ "{:,.0f}".format(item.total_amount) }}</td>
                        <td>{{ item.percentage }}%</td>
                        <td>{{ item.cumulative_percentage }}%</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-3">کالایی در این کلاس وجود ندارد</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Class B Items -->
<div class="card mb-4">
    <div class="card-header bg-warning text-dark">
        <i class="fas fa-exclamation-circle me-2"></i>
        کلاس B: اقلام مهم ({{ classified.B | length }} کالا)
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-warning">
                    <tr>
                        <th>کد کالا</th>
                        <th>نام کالا</th>
                        <th>واحد</th>
                        <th>مقدار کل</th>
                        <th>مبلغ کل</th>
                        <th>درصد سهم</th>
                        <th>درصد تجمعی</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in classified.B %}
                    <tr>
                        <td><code>{{ item.item_code }}</code></td>
                        <td>{{ item.item_name }}</td>
                        <td>{{ item.unit }}</td>
                        <td class="number-fa">{{ "{:,.2f}".format(item.total_quantity) }}</td>
                        <td class="number-fa fw-bold">{{ "{:,.0f}".format(item.total_amount) }}</td>
                        <td>{{ item.percentage }}%</td>
                        <td>{{ item.cumulative_percentage }}%</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-3">کالایی در این کلاس وجود ندارد</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Class C Items -->
<div class="card">
    <div class="card-header bg-secondary text-white">
        <i class="fas fa-info-circle me-2"></i>
        کلاس C: اقلام معمولی ({{ classified.C | length }} کالا)
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-secondary">
                    <tr>
                        <th>کد کالا</th>
                        <th>نام کالا</th>
                        <th>واحد</th>
                        <th>مقدار کل</th>
                        <th>مبلغ کل</th>
                        <th>درصد سهم</th>
                        <th>درصد تجمعی</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in classified.C %}
                    <tr>
                        <td><code>{{ item.item_code }}</code></td>
                        <td>{{ item.item_name }}</td>
                        <td>{{ item.unit }}</td>
                        <td class="number-fa">{{ "{:,.2f}".format(item.total_quantity) }}</td>
                        <td class="number-fa fw-bold">{{ "{:,.0f}".format(item.total_amount) }}</td>
                        <td>{{ item.percentage }}%</td>
                        <td>{{ item.cumulative_percentage }}%</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-3">کالایی در این کلاس وجود ندارد</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
