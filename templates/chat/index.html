{% extends "base.html" %}

{% block title %}چت‌بات تحلیلی - سیستم موجودی هتل{% endblock %}

{% block extra_css %}
<style>
    /* Minimal, neutral UI */
    .chat-container {
        height: calc(100vh - 200px);
        min-height: 480px;
        display: flex;
        flex-direction: column;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    }
    .chat-header {
        background: #f8f9fa;
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        color: #2f343a;
    }
    .chat-header h4 { margin: 0; font-weight: 600; }
    .chat-header .stats { font-size: 0.9rem; color: #6c757d; }
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 18px;
        background: #fcfcfc;
    }
    .message { margin-bottom: 12px; }
    .message-bot, .message-user { display: flex; align-items: flex-start; }
    .message-user { flex-direction: row-reverse; }
    .message-avatar {
        width: 38px; height: 38px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 18px; flex-shrink: 0;
        background: #eef1f4; color: #4a5568; margin: 0 10px;
    }
    .message-content {
        max-width: 75%;
        padding: 12px 14px;
        border-radius: 12px;
        background: #f5f7fa;
        color: #1f2933;
        border: 1px solid #e5e7eb;
    }
    .message-user .message-content {
        background: #eef2f7;
        border-color: #d9dde3;
    }
    .message-content p { margin: 0; line-height: 1.6; white-space: pre-wrap; }
    .message-content strong { color: #1f2933; }
    .message-time { font-size: 0.75rem; color: #8c98a4; margin-top: 6px; }
    .suggestions {
        display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;
    }
    .suggestion-btn {
        background: #f1f3f5; color: #2f343a;
        border: 1px solid #e0e3e7;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
    }
    .suggestion-btn:hover { background: #e7eaee; transform: translateY(-1px); }
    .chat-input-area { padding: 14px 16px; background: #f8f9fa; border-top: 1px solid #e5e7eb; }
    .chat-input-wrapper { display: flex; gap: 8px; align-items: center; }
    .chat-input {
        flex: 1; border: 1px solid #dce0e4; border-radius: 10px;
        padding: 10px 12px; font-size: 1rem; transition: border 0.2s ease; direction: rtl;
    }
    .chat-input:focus { outline: none; border-color: #a0aec0; box-shadow: none; }
    .send-btn {
        min-width: 44px; height: 44px; border-radius: 10px;
        background: #4a5568; border: none; color: white; font-size: 1rem;
        cursor: pointer; transition: background 0.2s ease;
    }
    .send-btn:hover { background: #3b4657; }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .typing-indicator { display: none; padding: 8px 16px; color: #6c757d; font-size: 0.9rem; }
    .typing-indicator.show { display: flex; align-items: center; gap: 6px; }
    .typing-dot {
        width: 6px; height: 6px; background: #6c757d; border-radius: 50%;
        animation: typing 1.2s infinite ease-in-out;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
    .welcome-message { text-align: center; padding: 30px 15px; color: #4a5568; }
    .welcome-message h5 { margin-bottom: 10px; font-weight: 600; }
    .welcome-message p { margin-bottom: 14px; color: #6c757d; }
    .chat-messages::-webkit-scrollbar { width: 6px; }
    .chat-messages::-webkit-scrollbar-thumb { background: #cbd2d9; border-radius: 3px; }
    .quick-stats { display: flex; gap: 10px; margin-top: 8px; }
    .stat-card { background: #eef1f4; padding: 6px 10px; border-radius: 8px; font-size: 0.85rem; color: #4a5568; }
    .stat-card .value { font-weight: 700; font-size: 1rem; color: #2f343a; }
    .message-content table { width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 0.9rem; }
    .message-content table th, .message-content table td { border: 1px solid #dfe3e8; padding: 6px; text-align: center; }
    .message-content table th { background: #f1f3f5; color: #2f343a; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <div class="chat-container">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4>چت‌بات تحلیلی هوشمند</h4>
                            <div class="stats">
                                پاسخ‌دهی real-time با حافظه مکالمه
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="quick-stats" id="quickStats">
                                <div class="stat-card">
                                    <div class="value" id="totalItems">-</div>
                                    <div>کالا</div>
                                </div>
                                <div class="stat-card">
                                    <div class="value" id="todayTrans">-</div>
                                    <div>تراکنش امروز</div>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" id="clearHistoryBtn" title="پاک کردن تاریخچه">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages">
                    <!-- Welcome Message -->
                    <div class="welcome-message" id="welcomeMessage">
                        <div class="icon"></div>
                        <h5>به چت‌بات تحلیلی خوش آمدید!</h5>
                        <p>هر سوالی درباره موجودی، خرید، مصرف، ضایعات یا تحلیل پارتو دارید بپرسید.</p>
                        <div class="suggestions" id="initialSuggestions">
                            <!-- Filled by JS -->
                        </div>
                    </div>
                </div>
                
                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator">
                    <div class="message-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 30px; height: 30px; margin-left: 10px;">
                        AI
                    </div>
                    <div style="display: flex; align-items: center; padding: 10px;">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="chat-input-area">
                    <form id="chatForm" class="chat-input-wrapper">
                        <input type="text" 
                               class="chat-input" 
                               id="chatInput" 
                               placeholder="سوال خود را بنویسید... (مثال: خلاصه وضعیت)"
                               autocomplete="off">
                        <button type="submit" class="send-btn" id="sendBtn">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const initialSuggestions = document.getElementById('initialSuggestions');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    
    // Load quick stats
    loadQuickStats();
    
    // Load initial suggestions
    loadSuggestions();
    
    // Load previous chat history
    loadChatHistory();
    
    // Clear history button handler
    clearHistoryBtn.addEventListener('click', async function() {
        if (!confirm('آیا از پاک کردن تاریخچه مکالمات مطمئن هستید؟')) return;
        
        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            const response = await fetch('/chat/api/clear-history', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });
            const data = await response.json();
            if (data.success) {
                // Clear messages and show welcome
                chatMessages.innerHTML = '';
                chatMessages.appendChild(welcomeMessage);
                welcomeMessage.style.display = 'block';
                loadSuggestions();
            }
        } catch (error) {
            console.error('Error clearing history:', error);
        }
    });
    
    // Form submit handler
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (!message) return;
        
        // Hide welcome message
        if (welcomeMessage) {
            welcomeMessage.style.display = 'none';
        }
        
        // Add user message
        addMessage(message, 'user');
        chatInput.value = '';
        
        // Show typing indicator
        showTyping(true);
        
        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            const response = await fetch('/chat/api/message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ message: message })
            });
            
            const data = await response.json();
            
            // Hide typing indicator
            showTyping(false);
            
            // Add bot response
            addMessage(data.response, 'bot', data.suggestions, data.timestamp);
            
        } catch (error) {
            showTyping(false);
            addMessage('متأسفانه خطایی رخ داد. لطفاً دوباره تلاش کنید.', 'bot');
        }
    });
    
    function addMessage(text, type, suggestions = [], timestamp = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${type}`;
        
        const avatar = type === 'bot' ? 'AI' : '';
        const time = timestamp || new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
        
        // Convert markdown-like formatting
        let formattedText = text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>');
        
        // Convert simple tables
        if (formattedText.includes('|')) {
            formattedText = convertTable(formattedText);
        }
        
        let suggestionsHtml = '';
        if (suggestions && suggestions.length > 0 && type === 'bot') {
            suggestionsHtml = `
                <div class="suggestions">
                    ${suggestions.map(s => `<button class="suggestion-btn" onclick="askQuestion('${s}')">${s}</button>`).join('')}
                </div>
            `;
        }
        
        messageDiv.innerHTML = `
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">
                <p>${formattedText}</p>
                ${suggestionsHtml}
                <div class="message-time">${time}</div>
            </div>
        `;
        
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }
    
    function convertTable(text) {
        const lines = text.split('<br>');
        let inTable = false;
        let tableHtml = '';
        let result = [];
        
        for (let line of lines) {
            if (line.includes('|') && !line.includes('---')) {
                if (!inTable) {
                    inTable = true;
                    tableHtml = '<table>';
                }
                const cells = line.split('|').filter(c => c.trim());
                const isHeader = !tableHtml.includes('<tbody>');
                if (isHeader) {
                    tableHtml += '<thead><tr>' + cells.map(c => `<th>${c.trim()}</th>`).join('') + '</tr></thead><tbody>';
                } else {
                    tableHtml += '<tr>' + cells.map(c => `<td>${c.trim()}</td>`).join('') + '</tr>';
                }
            } else if (line.includes('---')) {
                // Skip separator line
                continue;
            } else {
                if (inTable) {
                    tableHtml += '</tbody></table>';
                    result.push(tableHtml);
                    tableHtml = '';
                    inTable = false;
                }
                result.push(line);
            }
        }
        
        if (inTable) {
            tableHtml += '</tbody></table>';
            result.push(tableHtml);
        }
        
        return result.join('<br>');
    }
    
    function showTyping(show) {
        typingIndicator.classList.toggle('show', show);
        sendBtn.disabled = show;
        if (show) scrollToBottom();
    }
    
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    async function loadQuickStats() {
        try {
            const response = await fetch('/chat/api/quick-stats');
            const data = await response.json();
            document.getElementById('totalItems').textContent = data.total_items.toLocaleString('fa-IR');
            document.getElementById('todayTrans').textContent = data.today_transactions.toLocaleString('fa-IR');
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }
    
    async function loadSuggestions() {
        try {
            const response = await fetch('/chat/api/suggestions');
            const data = await response.json();
            initialSuggestions.innerHTML = data.suggestions
                .map(s => `<button class="suggestion-btn" onclick="askQuestion('${s}')">${s}</button>`)
                .join('');
        } catch (error) {
            console.error('Error loading suggestions:', error);
        }
    }
    
    async function loadChatHistory() {
        try {
            const response = await fetch('/chat/api/history?limit=20');
            const data = await response.json();
            
            if (data.success && data.history && data.history.length > 0) {
                // Hide welcome message if we have history
                welcomeMessage.style.display = 'none';
                
                // Add each message from history
                data.history.forEach(msg => {
                    const type = msg.role === 'user' ? 'user' : 'bot';
                    addMessage(msg.content, type, [], formatTime(msg.created_at));
                });
                
                scrollToBottom();
            }
        } catch (error) {
            console.error('Error loading chat history:', error);
        }
    }
    
    function formatTime(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        return date.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
    }
    
    // Global function for suggestion buttons
    window.askQuestion = function(question) {
        chatInput.value = question;
        chatForm.dispatchEvent(new Event('submit'));
    };
    
    // Focus input on load
    chatInput.focus();
});
</script>
{% endblock %}
